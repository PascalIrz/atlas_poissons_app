---
title: "Atlas des poissons d'eau douce de Bretagne"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: cosmo

---

```{r setup, include = FALSE, echo = FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(mapview)
library(shiny)
library(sf)
library(leaflet)
```


```{r}
load(file = "donnees_appli.RData")
```

Sidebar {.sidebar data-width=350}
=====================================

```{r}

selectInput(
  "espece",
  "Choisissez une espèce",
  choices = unique(pt_data$esp_nom_commun),
  selected = 1
)

sliderInput(
  inputId = "annees",
  label = "Suivi temporel",
  min = min(pt_data$annee, na.rm = TRUE),
  max = max(pt_data$annee, na.rm = TRUE),
  value = c(
    min(pt_data$annee, na.rm = TRUE),
    max(pt_data$annee, na.rm = TRUE)
  ) ,
  round = 1, step = 1,
  sep = ""
)

```

```{r}


pt_data_aggr <- reactive({
  pt_data %>% 
  filter(annee >= input$annees[1],
         annee <= input$annees[2],
         esp_nom_commun == input$espece) %>% 
  group_by(code_coords) %>%
    summarise(statut = max(statut)) %>% 
  ungroup()
  })


pt_map_data <- reactive({ 
  pt_geo %>% 
  left_join(pt_data_aggr()) %>% 
  mutate(
    statut = as.character(statut),
    statut = ifelse(is.na(statut),
                    "Non prospecté",
                    statut))
  })


bv_data_aggr <- reactive({
  bv_data %>% 
  filter(annee >= input$annees[1],
         annee <= input$annees[2],
         esp_nom_commun == input$espece) %>% 
  group_by(code_exutoire, code_espece, esp_nom_commun) %>%
    summarise(statut = max(statut)) %>% 
  ungroup()
  })


bv_map_data <- reactive({
  bv_simp_geo %>% 
  left_join(bv_data_aggr()) %>% 
  mutate(statut = as.character(statut),
         statut = ifelse(is.na(statut),
                          "Non prospecté",
                          statut),
         esp_nom_commun = ifelse(is.na(esp_nom_commun),
                              input$espece,
                              esp_nom_commun)) 
  })

m1 <- reactive({
  (mapview(bv_map_data(),
        zcol = "statut",
        layer.name = input$espece,
        map.types = c("OpenStreetMap", "Esri.WorldImagery"),
        col.regions = c("red", "pink", "grey70", "green"),
        alpha.regions = 0.5) +
    mapview(pt_map_data(),
          zcol = "statut",
          col.region = c("red", "pink", "grey90", "green"),
          map.types = c("OpenStreetMap", "Esri.WorldImagery"),
          legend = FALSE)) %>%
    .@map
  })

```


# Cartographie
```{r}


leaflet::renderLeaflet({ m1() %>% 
    leaflet::setView(-3, 48.2, zoom = 8) })



```

# Graphiques

```{r}

# A NETTOYER

occurence <- reactive ({ 
  pt_data %>% 
  filter(esp_nom_commun == input$espece) %>% 
  select(statut, annee)
  })

occ1 <- reactive ({
  occurence() %>% 
  filter(annee == 2011)
  })
occ1 <- reactive ({
  sum(occ1() == "Présent")
  })

occ2 <- reactive ({ 
  occurence() %>% 
  filter(annee == 2012)
  })
occ2 <- reactive ({
  sum(occ2() == "Présent")
  })

occ3 <- reactive ({ 
  occurence() %>% 
  filter(annee == 2013)
  })
occ3 <- reactive ({
  sum(occ3() == "Présent")
  })

occ4 <- reactive ({
  occurence() %>% 
  filter(annee == 2014)
  })
occ4 <- reactive ({
  sum(occ4() == "Présent")
  })

occ5 <- reactive ({
  occurence() %>% 
  filter(annee == 2015)
  })
occ5 <- reactive ({
  sum(occ5() == "Présent")
  })

occ6 <- reactive ({
  occurence() %>% 
  filter(annee == 2016)
  })
occ6 <- reactive ({
  sum(occ6() == "Présent")
  })

occ7 <- reactive ({
  occurence() %>% 
  filter(annee == 2017)
  })
occ7 <- reactive ({
  sum(occ7() == "Présent")
  })

occ8 <- reactive ({
  occurence() %>% 
  filter(annee == 2018)
  })
occ8 <- reactive ({
  sum(occ8() == "Présent")
  })

occ9 <- reactive ({
  occurence() %>% 
  filter(annee == 2019)
  })
occ9 <- reactive ({
  sum(occ9() == "Présent")
  })

occ10 <- reactive ({
  occurence() %>% 
  filter(annee == 2020)
  })
occ10 <- reactive ({
  sum(occ10() == "Présent")
  })

occ11 <- reactive ({
  occurence() %>% 
  filter(annee == 2021)
  })
occ11 <- reactive ({
  sum(occ11() == "Présent")
  })

annees <- pt_data %>%
  group_by(annee) %>%
  pull(annee) %>%
  unique() %>%
  sort()

occ <- reactive ({c(occ1(), occ2(), occ3(), occ4(), occ5(), occ6(), occ7(), occ8(), occ9(), occ10(), occ11())})

occurence_sp <- reactive ({data.frame(annees,occ())})

g1 <- reactive ({
  ggplot(occurence_sp(), aes(annees, occ)) +
  geom_point()
})

```

```{r}

renderPlot({
  g1()
})

```


# affichage

```{r}



```


# Méthodologie

- Jeux de données  
- Création des fonctions  