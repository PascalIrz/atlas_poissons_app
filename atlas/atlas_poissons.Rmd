---
title: "Atlas des poissons d'eau douce de Bretagne"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: cosmo

---

```{r setup, include = FALSE, echo = FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(mapview)
library(shiny)
library(sf)
library(leaflet)
```


```{r}
load(file = "donnees_appli.RData")
```

Sidebar {.sidebar data-width=350}
=====================================

```{r}

selectInput(
  "espece",
  "Choisissez une espèce",
  choices = unique(data_pt$esp_nom_commun),
  selected = 1
)

sliderInput(
  inputId = "annees",
  label = "Suivi temporel",
  min = min(data_pt$annee, na.rm = TRUE),
  max = max(data_pt$annee, na.rm = TRUE),
  value = c(
    min(data_pt$annee, na.rm = TRUE),
    max(data_pt$annee, na.rm = TRUE)
  ) ,
  round = TRUE,
  sep = ""
)
```

```{r}
sel_pt_data <- reactive({
  data_pt %>%
    filter(esp_nom_commun == input$espece,
           annee >= input$annees[1],
           annee <= input$annees[2]) %>% 
  group_by(code_station) %>% 
    summarise(
      effectif_tot = sum(effectif, na.rm = T),
      nb_annees_ech = n_distinct(annee),
      presence = (effectif_tot > 0) 
    )
  })



sel_pt_data_geo <- reactive({
  pts_geo %>% 
    filter(code_station %in% sel_pt_data()$code_station) %>% 
    left_join(y = sel_pt_data()) 
  })



esp_nom_commun <- reactive({
  sel_pt_data() %>% 
    slice(1) %>% 
    pull(esp_nom_commun) %>% 
    paste0(" : ", input$espece)
  })


n_lignes <- reactive({
  sel_pt_data() %>%
    nrow()
})


m1 <- reactive({
  mapview::mapview(sel_pt_data_geo(),
                   zcol = "presence") %>%
    .@map
  })
```







# Carte b



Bla

### ariof^ù

```{r}
renderValueBox(esp_nom_commun())
renderValueBox(paste0(n_lignes(), " observations"))
```


### arf

pt_geo
```{r}
pts_geo %>% class()
```

sel_pt_data
```{r}
reactive({sel_pt_data() %>% class()})
```

sel_pt_geo
```{r}
reactive({sel_ope_geo() %>% class()})
```

# aeurhf

```{r}
    # zoom_level <- reactive({
    #     if(is.null(input$m1_zoom)) {
    #       zoom <- 6
    #     } else {
    #       zoom <- input$m1_zoom
    #     }
    #   zoom
    # })

# solution trouvée sur https://stackoverflow.com/questions/36679944/mapview-for-shiny

# reactive({lignes() %>% class()})

leaflet::renderLeaflet({
  m1() #%>%
   # leaflet::setView(-3, 48, zoom = 8)
  })

```

# bl

```{r}
h1("rpg")
```


ESPECE `r reactive({esp_nom_commun()})`

Variables de lignes() : `r reactive({names(sel_pt_data()) %>% paste(collapse = " / ")})`


# Méthodologie

Expliquer ici la méthodologie











