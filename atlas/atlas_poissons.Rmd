---
title: "Atlas des poissons d'eau douce de Bretagne"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: cosmo

---

```{r setup, include = FALSE, echo = FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(mapview)
library(leafpop)
library(shiny)
library(sf)
library(leaflet)
source("gg_temp.R")
library(gt)
```


```{r}
load(file = "donnees_appli.RData")
```

Sidebar {.sidebar data-width=350}
=====================================

```{r}

# Slider années
sliderInput(
  inputId = "annees",
  label = "Années",
  min = min(pt_data$annee, na.rm = TRUE),
  max = max(pt_data$annee, na.rm = TRUE),
  value = c(
    min(pt_data$annee, na.rm = TRUE),
    max(pt_data$annee, na.rm = TRUE)
  ) ,
  round = 1,
  step = 1,
  sep = ""
)

# Menu sélection espèce
selectInput("espece",
            "Choisissez une espèce",
            choices = sort(unique(pt_data$esp_nom_commun)),
            selected = 1)

# Affichage du statut UICN de l'espèce
liste_rouge <- reactive ({
  pt_data %>%
    select(esp_nom_commun, lr_nationale, lr_regionale) %>%
    filter(esp_nom_commun == input$espece) %>%
    rename(
      "Nom commun" = esp_nom_commun,
      "Liste Rouge France" = lr_nationale,
      "Liste Rouge Bretagne" = lr_regionale
    ) %>%
    distinct()
})

fiche_inpn <- reactive ({
  pt_data %>%
    filter(esp_nom_commun == input$espece) %>%
    select(fiche) %>%
    # rename("Fiche INPN" = fiche)  %>%
    distinct() 
    # %>% 
    # Technique 1
    # mutate(
    #   "Fiche INPN"  = glue::glue("[fiche]({`Fiche INPN`})"),
    #   "Fiche INPN"  = map("Fiche INPN" , gt::md)) %>%
    # gt()
    #
    # Technique 2
    # mutate(
    #     "Fiche INPN" = map("Fiche INPN", ~ htmltools::a(href = .x, "Fiche")),
    #     "Fiche INPN" = map("Fiche INPN", ~ gt::html(as.character(.x)))) %>%
    # gt()
    #
    # Technique 3
    mutate(fiche =  paste0("<a href='",pt_data$fiche,"'target='_blank'>"
  ,"Fiche INPN", "</a>")) %>%
    DT::datatable(pt_data[, pt_data$fiche, drop = FALSE])
})

renderTable ({
  liste_rouge()
})
renderTable({
  fiche_inpn()
})

```

__**Légende**__  
**EX** = Eteint / Extinct  
**EW** = Eteint à l'état sauvage / Extinct in the wild  
**CR** = En danger critique d'extinction / Critically endangered  
**EN** = En danger / Endangered  
**VU** = Vulnérable / Vulnerable  
**NT** = Quasi menacé / Near threatened  
**LC** = Préoccupation mineure / Least Concerned  
**DD** = Données insufisantes / Data Deficient  
**NE - NA** = Non évalué - Non applicable / Non Evaluated  


```{r}

# Construction objects reactive

# Objet couleurs 
couleurs <- c("#CC0000", "#FF99CC", "grey70", "#33FF66")

# Aggrégation des données au point
pt_data_aggr <- reactive({
  pt_data %>% 
  filter(annee >= input$annees[1],
         annee <= input$annees[2],
         esp_nom_commun == input$espece) %>% 
  group_by(code_coords, esp_nom_commun, localisation, effectif) %>%
    summarise(statut = max(statut)) %>% 
  ungroup()
  })

# Ajout de la géométrie au point
pt_map_data <- reactive({ 
  pt_geo %>% 
  left_join(pt_data_aggr()) %>% 
  mutate(
    statut = as.character(statut),
    statut = ifelse(is.na(statut),
                    "Non prospecté",
                    statut)) %>% 
    rename("Localisation" = localisation,
           "Espèce" = esp_nom_commun,
           "Statut" = statut,
           "Abondance" = effectif)
  })

# Aggrégation des données au bv
bv_data_aggr <- reactive({
  bv_data %>% 
  filter(annee >= input$annees[1],
         annee <= input$annees[2],
         esp_nom_commun == input$espece) %>% 
  group_by(code_exutoire, code_espece, esp_nom_commun, effectif) %>%
    summarise(statut = max(statut)) %>% 
  ungroup()
  })

# Ajout de la géométrie au bv
bv_map_data <- reactive({
  bv_simp_geo %>% 
  left_join(bv_data_aggr()) %>% 
    group_by(code_exutoire, code_espece, esp_nom_commun, effectif) %>%
  mutate(statut = as.character(statut),
         statut = ifelse(is.na(statut),
                          "Non prospecté",
                          statut),
         esp_nom_commun = ifelse(is.na(esp_nom_commun),
                              input$espece,
                              esp_nom_commun)) %>% 
    rename("Nom du bassin" = toponyme,
           "Espèce" = esp_nom_commun,
           "Statut" = statut,
           "Abondance" = effectif)
  })

# Construction des deux cartes (assemblées)
m1 <- reactive({
  (mapview(bv_map_data(),
        zcol = "Statut",
        layer.name = input$espece,
        map.types = c("OpenStreetMap", "Esri.WorldImagery"),
        col.regions = couleurs,
        alpha.regions = 0.5,
          popup = popupTable(bv_map_data(),
                   zcol = c("Nom du bassin",
                            "Espèce",
                            "Statut",
                            "Abondance"
                            ),
                   row.numbers=FALSE,
                   feature.id = FALSE)) +
    mapview(pt_map_data(),
          zcol = "Statut",
          col.region = couleurs,
     #     map.types = c("OpenStreetMap", "Esri.WorldImagery"),
          cex = ifelse(pt_map_data()$Statut == "Non prospecté", 2, 4),
          legend = FALSE,
          popup = popupTable(pt_map_data(),
                   zcol = c("Localisation",
                            "Espèce",
                            "Statut",
                            "Abondance"),
                   row.numbers = FALSE,
                   feature.id = FALSE)
          )) %>%
    .@map
  })

```


# Cartographie
```{r}


leaflet::renderLeaflet({ m1() %>%
    leaflet::setView(lng = -3,
                     lat = 48.2,
                     zoom = 8)
  })



```

# Graphiques

```{r}

# =====================================
# CALCUL DATA POUR ETUDE

data_etude <- reactive ({
  pt_data %>%
    filter(esp_nom_commun == input$espece,
           statut == "Présent") %>%
    group_by(annee, statut) %>%
    summarise(abondance = sum(effectif),
              n_presence = n())
})

g1 <- reactive ({
  gg_temp(data = data_etude(),
          var_x = annee,
          var_y = n_presence)
})

g2 <- reactive ({
  gg_temp(data = data_etude(),
          var_x = annee,
          var_y = abondance)
})

```

## Présences
```{r}
renderPlot({ g1() })

```

## Abondances
```{r}

renderPlot({ g2() })

```

# affichage

```{r}



```


# Méthodologie

- Jeux de données  
- Création des fonctions  